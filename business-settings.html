<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Business Account Settings - STIF SME Portal">
    <title>Account Settings | STIF - Sustainability Technology and Innovation Forum</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <style>
        .settings-layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .settings-sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: var(--space-6);
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .settings-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .settings-nav-item {
            margin-bottom: var(--space-2);
        }
        
        .settings-nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            transition: all var(--transition);
        }
        
        .settings-nav-link:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }
        
        .settings-nav-link.active {
            background: var(--primary-100);
            color: var(--primary);
        }
        
        .settings-content {
            flex: 1;
            padding: var(--space-8);
            background: var(--gray-50);
        }
        
        .settings-container {
            max-width: 800px;
        }
        
        .settings-header {
            margin-bottom: var(--space-8);
        }
        
        .settings-title {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }
        
        .settings-description {
            color: var(--gray-600);
        }
        
        .settings-section {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-icon.primary {
            background: var(--primary-100);
            color: var(--primary);
        }
        
        .section-icon.environmental {
            background: var(--environmental-bg);
            color: var(--environmental);
        }
        
        .section-icon.social {
            background: var(--social-bg);
            color: var(--social);
        }
        
        .section-icon.governance {
            background: var(--governance-bg);
            color: var(--governance);
        }
        
        .section-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }
        
        .form-group {
            margin-bottom: var(--space-4);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 500;
            color: var(--gray-700);
            font-size: var(--text-sm);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
            background: white;
            transition: all var(--transition);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-100);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .action-buttons {
            display: flex;
            gap: var(--space-4);
            justify-content: flex-end;
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--gray-200);
        }
        
        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .alert-success {
            background: var(--success-100);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
            }
            
            .settings-sidebar {
                width: 100%;
                height: auto;
                position: relative;
                top: 0;
                padding: var(--space-4);
            }
            
            .settings-nav {
                display: flex;
                flex-wrap: wrap;
                gap: var(--space-2);
            }
            
            .settings-content {
                padding: var(--space-4);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <img src="assets/images/logo1.png" alt="STIF Logo" class="logo-img">
                <span class="logo-text">Sustainability Technology and Innovation Forum</span>
            </a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="/" class="nav-link">Home</a></li>
                    <li><a href="/business-dashboard.html" class="nav-link">Dashboard</a></li>
                    <li><a href="/business-settings.html" class="nav-link active">Settings</a></li>
                </ul>
            </nav>
            <div class="nav-actions"></div>
            <button class="mobile-menu-toggle" aria-label="Toggle menu">
                <span></span><span></span><span></span>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <button class="mobile-menu-close">&times;</button>
        <ul class="mobile-nav-menu"></ul>
    </div>

    <!-- Main Content -->
    <main class="settings-layout">
        <!-- Sidebar Navigation -->
        <aside class="settings-sidebar">
            <ul class="settings-nav">
                <li class="settings-nav-item">
                    <a href="#profile" class="settings-nav-link active" data-section="profile">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Profile Information
                    </a>
                </li>
                <li class="settings-nav-item">
                    <a href="#company" class="settings-nav-link" data-section="company">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                        </svg>
                        Company Details
                    </a>
                </li>
                <li class="settings-nav-item">
                    <a href="#contact" class="settings-nav-link" data-section="contact">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        Contact Information
                    </a>
                </li>
                <li class="settings-nav-item">
                    <a href="#sustainability" class="settings-nav-link" data-section="sustainability">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Sustainability Focus
                    </a>
                </li>
                <li class="settings-nav-item">
                    <a href="/business-dashboard.html" class="settings-nav-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Back to Dashboard
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Settings Content -->
        <div class="settings-content">
            <div class="settings-container">
                <!-- Loading State -->
                <div id="loading-state" class="flex-center" style="height: 400px;">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Settings Form (hidden until loaded) -->
                <div id="settings-form" class="hidden">
                    <div class="settings-header">
                        <h1 class="settings-title">Account Settings</h1>
                        <p class="settings-description">Manage your business profile and sustainability preferences</p>
                    </div>

                    <!-- Alert Messages -->
                    <div id="success-alert" class="alert alert-success hidden">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span>Settings saved successfully!</span>
                    </div>
                    <div id="error-alert" class="alert alert-error hidden">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <span id="error-message">An error occurred. Please try again.</span>
                    </div>

                    <!-- Profile Information Section -->
                    <section id="profile" class="settings-section">
                        <div class="section-header">
                            <div class="section-icon primary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <h2 class="section-title">Profile Information</h2>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" id="first_name" class="form-input" placeholder="Enter first name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" id="last_name" class="form-input" placeholder="Enter last name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Title / Role</label>
                            <input type="text" id="job_title" class="form-input" placeholder="e.g., Sustainability Manager">
                        </div>
                    </section>

                    <!-- Company Details Section -->
                    <section id="company" class="settings-section">
                        <div class="section-header">
                            <div class="section-icon environmental">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                </svg>
                            </div>
                            <h2 class="section-title">Company Details</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" id="company_name" class="form-input" placeholder="Enter company name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Industry</label>
                                <select id="industry" class="form-select">
                                    <option value="">Select industry</option>
                                    <option value="agriculture">Agriculture & Food</option>
                                    <option value="construction">Construction & Real Estate</option>
                                    <option value="energy">Energy & Utilities</option>
                                    <option value="finance">Financial Services</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="manufacturing">Manufacturing</option>
                                    <option value="retail">Retail & Consumer Goods</option>
                                    <option value="technology">Technology & IT</option>
                                    <option value="transport">Transport & Logistics</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company Size</label>
                                <select id="company_size" class="form-select">
                                    <option value="">Select size</option>
                                    <option value="1-10">1-10 employees</option>
                                    <option value="11-50">11-50 employees</option>
                                    <option value="51-200">51-200 employees</option>
                                    <option value="201-500">201-500 employees</option>
                                    <option value="501+">501+ employees</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Website</label>
                                <input type="url" id="website" class="form-input" placeholder="https://example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Country</label>
                                <input type="text" id="country" class="form-input" placeholder="Enter country">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Business Address</label>
                            <textarea id="business_address" class="form-textarea" placeholder="Enter full business address"></textarea>
                        </div>
                    </section>

                    <!-- Contact Information Section -->
                    <section id="contact" class="settings-section">
                        <div class="section-header">
                            <div class="section-icon social">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                            </div>
                            <h2 class="section-title">Contact Information</h2>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Business Email</label>
                                <input type="email" id="business_email" class="form-input" placeholder="contact@company.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mobile Number</label>
                                <input type="tel" id="mobile_number" class="form-input" placeholder="+1 234 567 8900">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Office Phone</label>
                                <input type="tel" id="office_phone" class="form-input" placeholder="+1 234 567 8901">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LinkedIn Profile</label>
                                <input type="url" id="linkedin_url" class="form-input" placeholder="https://linkedin.com/in/username">
                            </div>
                        </div>
                    </section>

                    <!-- Sustainability Focus Section -->
                    <section id="sustainability" class="settings-section">
                        <div class="section-header">
                            <div class="section-icon governance">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                            </div>
                            <h2 class="section-title">Sustainability Focus</h2>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Primary ESG Focus</label>
                                <select id="primary_esg_focus" class="form-select">
                                    <option value="">Select focus area</option>
                                    <option value="environmental">Environmental</option>
                                    <option value="social">Social</option>
                                    <option value="governance">Governance</option>
                                    <option value="all">All Areas</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reporting Year</label>
                                <select id="reporting_year" class="form-select">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026" selected>2026</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ongoing ESG Initiatives</label>
                            <textarea id="ongoing_esg_initiatives" class="form-textarea" placeholder="Describe your current sustainability initiatives, goals, and progress..."></textarea>
                        </div>
                    </section>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="button" id="cancel-btn" class="btn btn-outline">Cancel</button>
                        <button type="button" id="save-btn" class="btn btn-primary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="supabase-service.js"></script>
    <script src="champion-auth-supabase.js"></script>
    <script src="dynamic-navigation.js"></script>
    <script src="mobile-menu.js"></script>
        <script src="user-type-control.js"></script>
    <script>
        let currentUser = null;
        let originalData = {};
        
        const fields = [
            'first_name', 'last_name', 'job_title', 'company_name', 'industry', 
            'company_size', 'website', 'country', 'business_address', 
            'business_email', 'mobile_number', 'office_phone', 'linkedin_url',
            'primary_esg_focus', 'reporting_year', 'ongoing_esg_initiatives'
        ];
        
        async function checkAuth() {
            const supabase = window.getSupabase();
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = '/business-login.html';
                return;
            }
            
            const { data: businessUser, error } = await supabase.from('business_users').select('*').eq('auth_user_id', session.user.id).single();
            
            if (error || !businessUser) {
                window.location.href = '/business-login.html';
                return;
            }
            
            currentUser = businessUser;
            populateForm();
        }
        
        function populateForm() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('settings-form').classList.remove('hidden');
            
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el && currentUser[field]) {
                    el.value = currentUser[field];
                    originalData[field] = currentUser[field];
                }
            });
        }
        
        async function saveSettings() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading-spinner" style="width: 18px; height: 18px;"></span> Saving...';
            
            hideAlerts();
            
            const updateData = {};
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el) updateData[field] = el.value.trim();
            });
            
            try {
                const supabase = window.getSupabase();
                const { error } = await supabase.from('business_users').update(updateData).eq('id', currentUser.id);
                
                if (error) throw error;
                
                originalData = { ...updateData };
                showSuccess();
            } catch (err) {
                showError(err.message || 'Failed to save settings');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save Changes';
            }
        }
        
        function cancelChanges() {
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el) el.value = originalData[field] || '';
            });
            hideAlerts();
        }
        
        function showSuccess() {
            document.getElementById('success-alert').classList.remove('hidden');
            setTimeout(() => document.getElementById('success-alert').classList.add('hidden'), 5000);
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-alert').classList.remove('hidden');
        }
        
        function hideAlerts() {
            document.getElementById('success-alert').classList.add('hidden');
            document.getElementById('error-alert').classList.add('hidden');
        }
        
        // Sidebar navigation highlighting
        document.querySelectorAll('.settings-nav-link[data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                document.querySelectorAll('.settings-nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });
        
        document.getElementById('save-btn').addEventListener('click', saveSettings);
        document.getElementById('cancel-btn').addEventListener('click', cancelChanges);
        
        checkAuth();
    </script>
</body>
</html>
