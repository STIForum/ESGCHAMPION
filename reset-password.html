<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Set your new password - STIF">
    <title>Reset Password | STIF - Sustainability Technology and Innovation Forum</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .auth-page {
            min-height: calc(100vh - 70px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(70px + var(--space-8)) var(--space-6) var(--space-8);
            background: linear-gradient(135deg, var(--primary-50) 0%, white 50%, var(--gray-50) 100%);
        }
        .auth-card {
            width: 100%;
            max-width: 440px;
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            padding: var(--space-10);
        }
        .auth-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }
        .auth-icon {
            width: 64px;
            height: 64px;
            background: var(--primary-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-4);
            color: var(--primary);
        }
        .auth-icon.success { background: var(--success-100); color: var(--success); }
        .auth-icon.error { background: var(--error-100); color: var(--error); }
        .auth-title {
            font-size: var(--text-2xl);
            margin-bottom: var(--space-2);
        }
        .auth-subtitle {
            color: var(--gray-500);
            font-size: var(--text-sm);
        }
        .auth-footer {
            text-align: center;
            margin-top: var(--space-6);
        }
        .auth-footer p {
            color: var(--gray-500);
            font-size: var(--text-sm);
        }
        .success-message {
            background: var(--success-100);
            border: 1px solid var(--success);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            color: var(--success);
            text-align: center;
        }
        .error-message {
            background: var(--error-100);
            border: 1px solid var(--error);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            color: var(--error);
            font-size: var(--text-sm);
        }
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-400);
            padding: 4px;
        }
        .password-toggle:hover { color: var(--gray-600); }
        .password-field { position: relative; }
        .password-requirements {
            font-size: var(--text-xs);
            color: var(--gray-500);
            margin-top: var(--space-1);
        }
        .password-requirements ul {
            margin: var(--space-1) 0 0 var(--space-4);
        }
        .password-requirements li.valid { color: var(--success); }
        .password-requirements li.invalid { color: var(--error); }
        .hidden { display: none !important; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <img src="assets/images/logo1.png" alt="STIF Logo" class="logo-img">
                <span class="logo-text">Sustainability Technology and Innovation Forum</span>
            </a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="/" class="nav-link">Home</a></li>
                    <li><a href="/about.html" class="nav-link">About</a></li>
                    <li><a href="/faq.html" class="nav-link">FAQ</a></li>
                </ul>
            </nav>
            <div class="nav-actions">
                <a href="/champion-login.html" class="btn btn-ghost">Login</a>
                <a href="/champion-register.html" class="btn btn-primary">Get Started</a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle menu">
                <span></span><span></span><span></span>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <button class="mobile-menu-close">&times;</button>
        <ul class="mobile-nav-menu">
            <li><a href="/" class="mobile-nav-link">Home</a></li>
            <li><a href="/about.html" class="mobile-nav-link">About</a></li>
            <li><a href="/faq.html" class="mobile-nav-link">FAQ</a></li>
            <li><a href="/champion-login.html" class="mobile-nav-link">Login</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <main class="auth-page">
        <div class="auth-card">
            <!-- Loading View -->
            <div id="loading-view">
                <div class="auth-header">
                    <div class="loading-spinner" style="margin: 0 auto var(--space-4);"></div>
                    <h1 class="auth-title">Verifying...</h1>
                    <p class="auth-subtitle">Please wait while we verify your reset link.</p>
                </div>
            </div>

            <!-- Reset Form View -->
            <div id="reset-view" class="hidden">
                <div class="auth-header">
                    <div class="auth-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                        </svg>
                    </div>
                    <h1 class="auth-title">Set New Password</h1>
                    <p class="auth-subtitle">Enter your new password below.</p>
                </div>

                <div id="error-message" class="error-message hidden"></div>

                <form id="reset-form">
                    <div class="form-group">
                        <label class="form-label" for="password">New Password</label>
                        <div class="password-field">
                            <input type="password" id="password" name="password" class="form-input" 
                                   placeholder="••••••••" required minlength="8" autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                        <div class="password-requirements">
                            <p>Password must:</p>
                            <ul>
                                <li id="req-length">Be at least 8 characters</li>
                                <li id="req-upper">Include an uppercase letter</li>
                                <li id="req-lower">Include a lowercase letter</li>
                                <li id="req-number">Include a number</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirm-password">Confirm New Password</label>
                        <div class="password-field">
                            <input type="password" id="confirm-password" name="confirm-password" class="form-input" 
                                   placeholder="••••••••" required minlength="8" autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('confirm-password')">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-full" id="submit-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Reset Password
                    </button>
                </form>

                <div class="auth-footer">
                    <p>Remember your password? <a href="/champion-login.html">Sign In</a></p>
                </div>
            </div>

            <!-- Success View -->
            <div id="success-view" class="hidden">
                <div class="auth-header">
                    <div class="auth-icon success">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h1 class="auth-title">Password Reset!</h1>
                    <p class="auth-subtitle">Your password has been successfully updated. You can now sign in with your new password.</p>
                </div>
                
                <a href="/champion-login.html" class="btn btn-primary w-full mb-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Sign In as Champion
                </a>
                
                <a href="/business-login.html" class="btn btn-secondary w-full">
                    Sign In as Business
                </a>
            </div>

            <!-- Error View -->
            <div id="error-view" class="hidden">
                <div class="auth-header">
                    <div class="auth-icon error">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                    </div>
                    <h1 class="auth-title">Link Expired</h1>
                    <p class="auth-subtitle">This password reset link has expired or is invalid. Please request a new one.</p>
                </div>
                
                <a href="/forgot-password.html" class="btn btn-primary w-full">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Request New Link
                </a>
                
                <div class="auth-footer">
                    <p>Remember your password? <a href="/champion-login.html">Sign In</a></p>
                </div>
            </div>
        </div>
    </main>

    <script src="supabase-service.js"></script>
    <script src="mobile-menu.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const supabase = window.getSupabase();
            
            // Check for recovery token in URL hash
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');
            
            // Also check for error
            const error = hashParams.get('error');
            const errorDescription = hashParams.get('error_description');
            
            if (error) {
                console.error('Reset link error:', error, errorDescription);
                showView('error-view');
                return;
            }
            
            if (type === 'recovery' && accessToken) {
                // Valid recovery token - show reset form
                showView('reset-view');
            } else {
                // Check if user is already authenticated (for Supabase v2 auto-login flow)
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    showView('reset-view');
                } else {
                    // No valid token or session
                    showView('error-view');
                }
            }
        });

        // Password validation
        document.getElementById('password')?.addEventListener('input', function(e) {
            const password = e.target.value;
            validatePassword(password);
        });

        document.getElementById('reset-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const submitBtn = document.getElementById('submit-btn');
            const errorEl = document.getElementById('error-message');
            
            // Validate password
            if (!isPasswordValid(password)) {
                showError('Password does not meet the requirements.');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match.');
                return;
            }
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner-sm"></span> Updating...';
            errorEl.classList.add('hidden');
            
            try {
                const supabase = window.getSupabase();
                
                const { error } = await supabase.auth.updateUser({
                    password: password
                });
                
                if (error) throw error;
                
                // Sign out after password reset
                await supabase.auth.signOut();
                
                // Show success view
                showView('success-view');
                
            } catch (error) {
                console.error('Reset password error:', error);
                showError(error.message || 'Failed to reset password. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Reset Password`;
            }
        });

        function validatePassword(password) {
            const reqLength = document.getElementById('req-length');
            const reqUpper = document.getElementById('req-upper');
            const reqLower = document.getElementById('req-lower');
            const reqNumber = document.getElementById('req-number');
            
            // Length check
            if (password.length >= 8) {
                reqLength.classList.add('valid');
                reqLength.classList.remove('invalid');
            } else {
                reqLength.classList.add('invalid');
                reqLength.classList.remove('valid');
            }
            
            // Uppercase check
            if (/[A-Z]/.test(password)) {
                reqUpper.classList.add('valid');
                reqUpper.classList.remove('invalid');
            } else {
                reqUpper.classList.add('invalid');
                reqUpper.classList.remove('valid');
            }
            
            // Lowercase check
            if (/[a-z]/.test(password)) {
                reqLower.classList.add('valid');
                reqLower.classList.remove('invalid');
            } else {
                reqLower.classList.add('invalid');
                reqLower.classList.remove('valid');
            }
            
            // Number check
            if (/[0-9]/.test(password)) {
                reqNumber.classList.add('valid');
                reqNumber.classList.remove('invalid');
            } else {
                reqNumber.classList.add('invalid');
                reqNumber.classList.remove('valid');
            }
        }

        function isPasswordValid(password) {
            return password.length >= 8 &&
                   /[A-Z]/.test(password) &&
                   /[a-z]/.test(password) &&
                   /[0-9]/.test(password);
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
        }

        function showView(viewId) {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('reset-view').classList.add('hidden');
            document.getElementById('success-view').classList.add('hidden');
            document.getElementById('error-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
    </script>
</body>
</html>
